# 채번

현재 프로젝트에서 순번을 매기는 방법은 세가지다.

1. 공통 적용되는 ID 테이블 사용
2. sequence 사용
   > DB가 오라클이다.
3. max+1 사용

단순히 게시판 등의 순번이나 ID를 매기는 것이라면 큰 문제가 없겠지만, 기능이 추가되면서 고려할 사항이 생겼다.

## 문제 발생 배경

### SMS 기능

SMS문건에 변수를 지정하여 발송 전 메세지를 변환하는 방식으로 구현했다.

```js
// 예시
{시설}에 등록되었습니다.
```

현재 SMS의 건당 최대 길이가 80byte로 지정 되어 있는데, 위의 예시에서 시설 명이 너무 길어져 80byte를 초과하게 되면 SMS 솔루션에서 SMS가 발송되지 않도록 되어있다.

솔루션에 나눠보내기나 MMS로 보내기 기능이 있다면 사용하면 된다. 하지만 SMS 발송 솔루션이 오래되어 참조할 수 있는 기술 문서가 없는 상황이다.

해결책으로 최대길이를 초과하지 않도록 변환된 메세지를 잘라주는 방식을 사용했지만, SMS를 나눠서 보내는 방식으로 기능 변경을 하게 되었다.

### 기능 변경

SMS테이블을 공통으로 사용하기 때문에 특정 기능에서 전송된 SMS를 보기 위해서 history 테이블에도 항목을 저장해야 한다.

> 공통 테이블이기 때문에 구조 변경이 어렵고, 솔루션에서 제공하는 테이블에는 어떤 기능에서 전송 요청을 했는지 기록하지 않는다.

SMS 공통 테이블의 key 값을 가져와 history테이블에 참조 키로 사용하고 있었는데, 기존에는 큰 문제가 되지 않았지만 나눠 보내기 기능을 적용하며 문제가 발생했다.

SMS를 나눠보내게 되면 발송된 SMS의 key를 가져오기 때문에 하나의 트랜잭션 단위가 아닌 발송 자체 단위로 history가 저장된다.

- history table

  | pk  | text        |
  | --- | ----------- |
  | 1   | 시설에 등록 |
  | 2   | 되었습니다  |

이 경우 SMS가 어떻게 묶여있는지 제대로 확인하기 어렵다. 만약 SMS를 동시에 보내게 된다면 다음과 같은 경우가 발생할 수 있을 것이다.

- history table

  | pk  | text        |
  | --- | ----------- |
  | 1   | 시설에 등록 |
  | 2   | 시설에 등록 |
  | 3   | 되었습니다  |
  | 4   | 되었습니다  |

이렇게 될 경우 조회 뿐만 아니라 SMS 재전송 기능에도 문제가 생긴다.

따라서 다음과 같은 구조로 테이블을 변경하기로 했다.

- history table

  | seq | fk  | text        |
  | --- | --- | ----------- |
  | 1   | 1   | 시설에 등록 |
  | 2   | 2   | 시설에 등록 |
  | 1   | 3   | 되었습니다  |
  | 2   | 4   | 되었습니다  |

SMS 공통 테이블의 pk를 fk로 변경하고, history 테이블에 순번을 추가하여 복합키로 만들었다.

따라서 (당연하지만) history 테이블의 pk를 증가 시켜야하는데, 여기서 문제가 발생한다.

### 문제 상황

하나의 문자를 나눠서 전송하는 것이기 때문에 나눠서 전송하는 건들을 하나의 트랜잭션으로 묶어서 처리해야한다.

이 때 history 테이블에 정해진 key가 복합키이기 때문에 여러건이 동시에 처리된다면 순번이 중복될 가능성이 있다.

따라서 순번을 증가 시키는 방법에 대해 고민을 해봐야했다.

> 다음 글에 계속
